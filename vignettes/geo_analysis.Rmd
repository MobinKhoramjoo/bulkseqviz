---
output: rmarkdown::github_document
---

```{r, include=FALSE}         
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  warning = FALSE,
  message = FALSE,
  fig.width = 7, 
  fig.height = 5
)
```

## Real Dataset Analysis: showcasing usage of bulkseqviz library

## Introduction

This tutorial demonstrates an example analysis using `bulkseqvis`.

We will download a raw RNA-seq dataset from the NCBI Gene Expression Omnibus (GEO), clean the data, and generate publication-ready visualizations.

The dataset used in this example is [**GSE298714**](https://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=GSE298714 "null").

## 1. Setup and Libraries

First, we load the core package and necessary helper libraries for data retrieval and manipulation.

```{r} 
devtools::install_github("MobinKhoramjoo/bulkseqviz") 
library(bulkseqviz) 
library(GEOquery)   # For downloading data from NCBI 
library(dplyr)      # For data manipulation 
library(ggplot2)    # For plotting 
library(tidyverse)  # General data science tools 
library(biomaRt)    # For gene ID annotation 
```

## 2. Data Retrieval

We start by fetching the metadata (sample information) and the supplementary count files directly from GEO.

```{r}         
gse_id <- "GSE298714"

# 1. Fetch Metadata
# We use getGEO to download the phenotype data.
gse <- getGEO(gse_id, destdir = ".", getGPL = FALSE)

# Clean up the metadata. 
# We extract the 'category' (e.g., treatment group) from the characteristics column
# using regex to remove the field name prefix (e.g., "condition: Treated" -> "Treated").
metadata <- pData(gse[[1]]) %>% 
  mutate(category = str_replace(characteristics_ch1.4, ".*:\\s*", ""))

# 2. Fetch Raw Counts
# Download the supplementary files where raw counts are stored
getGEOSuppFiles(gse_id)

# Locate the file
supp_files <- list.files(gse_id)
count_file <- paste(gse_id, supp_files, sep = '/')

# Read the table
counts <- read.table(count_file, header = TRUE, row.names = 1, check.names = FALSE)

# Ensure column names in counts match the GEO Accession IDs in metadata
colnames(counts) <- metadata$geo_accession

# Cleanup
rm(gse)
```

## 3. Data Cleaning and Filtering

Raw RNA-seq data often includes non-coding RNAs or pseudogenes. For this analysis, we want to filter the dataset to keep only **protein-coding genes** using Ensembl annotations.

```{r}         
# Connect to Ensembl BioMart
mart <- useMart("ensembl", dataset = "hsapiens_gene_ensembl")

# Retrieve gene biotypes for our rows
genes_info <- getBM(
  attributes = c("ensembl_gene_id", "gene_biotype"),
  filters = "ensembl_gene_id",
  values = rownames(counts),
  mart = mart
)

# Identify protein-coding IDs
protein_coding_ids <- genes_info$ensembl_gene_id[genes_info$gene_biotype == "protein_coding"]

# Filter the count matrix
filtered_counts_df <- counts[rownames(counts) %in% protein_coding_ids, ]

# Data Type Conversion:
# DESeq2 requires integer counts. We convert the dataframe to ensure no floats exist.
filtered_counts_df <- as.data.frame(lapply(filtered_counts_df, as.integer))
rownames(filtered_counts_df) <- protein_coding_ids # Re-assign rownames lost during lapply

# Sanity Check: Do sample names match? 
# Should be matched for making bulkseqviz object
if(!all(colnames(filtered_counts_df) == rownames(metadata))) {
  stop("Mismatch between count columns and metadata rows!")
}
```

## 4. Creating the bulkseqviz Object

We wrap the cleaned counts and metadata into the `bulkseq` object. This creates a unified container that handles downstream normalization and plotting automatically.

```{r}         
bs_obj <- create_bulkseqvis_object(counts = filtered_counts_df, metadata = metadata)

# Print object summary
print(bs_obj)
```

## 5. Exploratory Data Analysis (EDA)

Before running statistics, we assess the quality of the data. We define a custom color palette to keep visualizations consistent across all plots.

```{r}         
# Define custom colors
my_color <- c('LMP' = 'lightblue', 'NST' = 'pink', 'VI' = 'purple')
# Define custom order
my_order <- c('LMP', 'NST', 'VI')

# A. Overall Count Distribution
# Checks for library size differences or major outliers
overall_count_boxplot(bs_obj, # created bulkseqviz object
                      color_by = "category",
                      group_order = my_order,
                      group_colors = my_color)

# B. Sample-to-Sample Distance Heatmap
sample_distance_heatmap(bs_obj, 
                        color_by = "category", 
                        fontsize = 9,
                        title = "Sample Distance Heatmap",
                        ann_colors = list(category = my_color)) 
```

We explore the data structure using linear (PCA) and non-linear (UMAP, t-SNE) techniques.

```{r}         
# PCA (2D)
plot_pca_2d(bs_obj, 
            color_by = "category",
            group_colors = my_color,
            ntop = 500)

# UMAP
plot_umap_2d(bs_obj, 
             color_by = "category",
             ntop = 500,
             n_neighbors = 10,
             group_colors = my_color)

# t-SNE
plot_tsne_2d(bs_obj, 
             color_by = "category",
             min_gene_counts = 10,
             ntop = 500,
             tsne_perplexity = 10,
             group_colors = my_color)
```

## 6. Differential Expression Analysis (DEA)

We perform differential expression analysis using `DESeq2`. Here we perform two pairwise comparisons against the "LMP" control group.

```{r}         
# Contrast 1: NST vs LMP
bs_obj <- DEG(bs_obj, 
              design_col = "category", 
              compare_levels = c("NST", "LMP"),
              biomart_dataset = 'hsapiens_gene_ensembl')

# Contrast 2: VI vs LMP
bs_obj <- DEG(bs_obj, 
              design_col = "category", 
              compare_levels = c("VI", "LMP"),
              biomart_dataset = 'hsapiens_gene_ensembl')
```

## 7. Visualizing Results

```{r}         
# Bar Plot Summary
plot_deg_bar(bs_obj,
             method = "padj",
             cutoff = 0.05,
             fc_cutoff = 1)

# Volcano Plot (NST vs LMP)
plot_volcano(bs_obj, 
             comparison_id = "NST_vs_LMP", 
             fc_thresh = 2,
             padj_thresh = 0.05,
             top_labels = 5,
             plot_title = "Volcano: NST vs LMP")

# Compare two contrasts (FC vs FC)
plot_fcvsfc(bs_obj, 
            name1 = "NST_vs_LMP", 
            name2 = "VI_vs_LMP",
            fc_cutoff = 2)
```

## 8. Gene-specific Visualization

We select the top 5 significant genes from the first comparison and visualize their expression.

```{r}         
# Extract top 5 genes
target_genes <- bs_obj$DE_results$NST_vs_LMP %>% 
  dplyr::arrange(padj) %>% 
  dplyr::slice_head(n=5) %>% 
  dplyr::pull(gene_id)

# Dotplot of Log2 Fold Changes
plot_fc_dotplot(bs_obj, genes = target_genes)

# Expression Boxplot 
plot_gene_boxplot(bs_obj, 
                  genes = target_genes, 
                  x_var = "category",
                  x_colors = my_color,
                  jitter_points = TRUE,
                  biomart_dataset = 'hsapiens_gene_ensembl') 

# Expression Boxplot (Baseline Normalized)
plot_gene_boxplot(bs_obj, 
                  genes = target_genes, 
                  x_var = "category",
                  x_colors = my_color,
                  jitter_points = TRUE,
                  normalize_to_baseline = TRUE,
                  biomart_dataset = 'hsapiens_gene_ensembl') 
```
